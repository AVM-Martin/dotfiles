#!/bin/bash -e
#
# Delete gone branches from a local repository
# Inspired from [1] with modifications
#
# [1]: https://www.erikschierboom.com/2020/02/17/cleaning-up-local-git-branches-deleted-on-a-remote/

NAME="$(basename "$0")"
PREFIX="\033[1;96m${NAME}\033[0m"
readonly NAME PREFIX

dryrun=1

while (( $# > 0 )); do
  case "$1" in
    -h|--help)
      echo -e "${PREFIX}: delete gone branches from a local repository."
      echo -e ""
      echo -e "Options:"
      echo -e "  -h, --help    : show this simple help"
      echo -e "  -n, --dry-run : show a list of gone branches"
      echo -e "  -f, --force n : force delete gone branches"
      exit 0
      ;;
    -n|--dry-run)
      dryrun=1
      shift # past argument
      ;;
    -f|--force)
      dryrun=0
      shift # past argument
      ;;
    *)
      echo -e "${PREFIX}: unrecognize argument $1"
      exit 1
      ;;
  esac
done

readonly dryrun

git fetch --quiet --prune

git for-each-ref --format '%(refname:lstrip=2) %(upstream:track)' refs/heads \
  | awk '$2 == "[gone]" {print $1}' \
  | { if (( dryrun == 1 )); then xargs -n 1 echo "Would remove"; else xargs -r git branch -D; fi }
